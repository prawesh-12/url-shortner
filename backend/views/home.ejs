<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>URL Shortener</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <div class="page-header">
      <h1>URL Shortener</h1>
      <div class="header-actions">
        <span id="userInfo" class="user-info"></span>
        <a href="/admin/urls" id="adminLink" class="admin-link hidden">Admin Panel</a>
        <a href="#" id="logoutBtn" class="logout-btn">Logout</a>
      </div>
    </div>
    <br>
    <div class="card">
      <form id="shortenForm">
        <div class="form-group">
          <input type="text" name="url" id="urlInput" placeholder="https://example.com/" required />
          <button type="submit">Shorten</button>
        </div>
      </form>

      <div id="errorBox" class="error-box hidden"></div>
      <div id="successBox" class="success-box hidden"></div>
      <div id="resultBox" class="result-box hidden">
        <span class="label">Short URL:</span>
        <a id="shortUrlLink" href="#" target="_blank"></a>
      </div>
    </div>

    <div class="card hidden" id="tableCard">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>S.No</th>
              <th>Short URL</th>
              <th>Redirect URL</th>
              <th>Clicks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="urlTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = 'http://localhost:8001';
    const token = localStorage.getItem('token');

    if (!token) {
      window.location.href = '/login';
    }

    function authHeaders(extra = {}) {
      return {
        'Authorization': `Bearer ${token}`,
        ...extra
      };
    }

    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.textContent = msg;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 5000);
    }

    function showSuccess(msg) {
      const box = document.getElementById('successBox');
      box.textContent = msg;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 5000);
    }

    async function loadUrls() {
      try {
        const res = await fetch('/url/all', {
          headers: authHeaders()
        });
        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        const data = await res.json();
        const urls = data.urls || [];
        const tbody = document.getElementById('urlTableBody');
        const tableCard = document.getElementById('tableCard');

        if (urls.length === 0) {
          tableCard.classList.add('hidden');
          return;
        }

        tableCard.classList.remove('hidden');
        tbody.innerHTML = urls.map((url, index) => `
          <tr>
            <td data-label="S.No">${index + 1}</td>
            <td data-label="Short URL">
              <a href="${BASE_URL}/url/${url.shortId}" target="_blank">
                ${BASE_URL}/url/${url.shortId}
              </a>
            </td>
            <td data-label="Redirect URL" title="${url.redirectURL}">${url.redirectURL}</td>
            <td data-label="Clicks"><span class="click-badge">${url.visitedHistory.length}</span></td>
            <td data-label="Action">
              <button class="delete-btn" onclick="deleteUrl('${url.shortId}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        showError('Failed to load URLs');
      }
    }

    // Shorten URL form
    document.getElementById('shortenForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = document.getElementById('urlInput').value;
      document.getElementById('resultBox').classList.add('hidden');

      try {
        const res = await fetch('/url', {
          method: 'POST',
          headers: authHeaders({
            'Content-Type': 'application/json'
          }),
          body: JSON.stringify({
            url
          }),
        });

        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          showError(data.error);
          return;
        }

        const shortUrl = `${BASE_URL}/url/${data.shortId}`;
        const resultBox = document.getElementById('resultBox');
        const link = document.getElementById('shortUrlLink');
        link.href = shortUrl;
        link.textContent = shortUrl;
        resultBox.classList.remove('hidden');

        document.getElementById('urlInput').value = '';
        loadUrls();
      } catch (err) {
        showError('Something went wrong. Please try again.');
      }
    });

    // Delete URL
    async function deleteUrl(shortId) {
      if (!confirm('Are you sure you want to delete this URL?')) return;

      try {
        const res = await fetch(`/url/delete/${shortId}`, {
          method: 'POST',
          headers: authHeaders(),
        });

        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          showError(data.error);
          return;
        }

        showSuccess('URL deleted successfully');
        loadUrls();
      } catch (err) {
        showError('Failed to delete URL');
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    // Decode JWT to show user info
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(atob(base64));
      } catch (e) {
        return null;
      }
    }

    const userData = parseJwt(token);
    if (userData) {
      document.getElementById('userInfo').innerHTML =
        `<strong>${userData.name}</strong> <span class="role-badge">${userData.role}</span>`;
      if (userData.role === 'ADMIN') {
        document.getElementById('adminLink').classList.remove('hidden');
      }
    }

    // Load URLs on page load
    loadUrls();
  </script>
</body>

</html>